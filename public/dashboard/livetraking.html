<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trip Tracking System</title>
  <link rel="stylesheet" href="dashboardstyle.css">
</head>
<body>
  <div class="container">
    <h1>Trip Tracking System</h1>
    <button id="startStopBtn">Start Trip</button>
    <div id="map" style="height: 500px; width: 100%;"></div>
    <div id="tripSummary">
      <h2>Trip Summary</h2>
      <p>Distance: <span id="distance">0</span> km</p>
      <p>Max Speed: <span id="maxSpeed">0</span> km/h</p>
      <p>Stops: <span id="stops">0</span></p>
      <p>Time Taken: <span id="timeTaken">00:00:00</span></p>
    </div>
  </div>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY"></script>
  <script src="dashboard.js"></script>
  <script>
    // Firebase configuration
    var firebaseConfig = {
    apiKey: "AIzaSyAa9bahojYMk_1meGG8YCgUDFNj6MEHPeI",
    authDomain: "espclientsnew.firebaseapp.com",
    databaseURL: "https://espclientsnew-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "espclientsnew",
    storageBucket: "espclientsnew.firebasestorage.app",
    messagingSenderId: "196283041268",
    appId: "1:196283041268:web:6f24e1202238bf01fea5a1"
};

// Initialize Firebase
const app = firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// Google Maps initialization
let map;
let marker;
let polyline;
let path = [];

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 37.7749, lng: -122.4194 }, // Default center
    zoom: 12,
  });
  marker = new google.maps.Marker({
    position: { lat: 37.7749, lng: -122.4194 },
    map: map,
  });
  polyline = new google.maps.Polyline({
    strokeColor: "#FF0000",
    strokeOpacity: 1.0,
    strokeWeight: 2,
    map: map,
  });
}

// Trip tracking variables
let tripActive = false;
let tripId;
let startTime;
let interval;
let maxSpeed = 0;
let stops = [];
let currentStop = null;
let previousPosition = null;

// Start/Stop Trip
const startStopBtn = document.getElementById("startStopBtn");
startStopBtn.addEventListener("click", () => {
  if (!tripActive) {
    startTrip();
  } else {
    stopTrip();
  }
});

function startTrip() {
  tripActive = true;
  startStopBtn.textContent = "Stop Trip";
  startTime = new Date().getTime();
  tripId = "trip_" + startTime;

  // Reset variables
  path = [];
  maxSpeed = 0;
  stops = [];
  currentStop = null;
  previousPosition = null;
  polyline.setPath(path);

  // Start listening to GPS data
  database.ref("User1/gps-data").on("value", (snapshot) => {
    const data = snapshot.val();
    if (data) {
      const latLng = new google.maps.LatLng(data.latitude, data.longitude);
      path.push(latLng);
      polyline.setPath(path);

      // Update marker
      marker.setPosition(latLng);
      map.setCenter(latLng);

      // Update max speed
      if (data.speed > maxSpeed) {
        maxSpeed = data.speed;
        document.getElementById("maxSpeed").textContent = maxSpeed;
      }

      // Calculate distance
      if (previousPosition) {
        const distance = google.maps.geometry.spherical.computeDistanceBetween(previousPosition, latLng);
        const totalDistance = parseFloat(document.getElementById("distance").textContent) + distance / 1000;
        document.getElementById("distance").textContent = totalDistance.toFixed(2);
      }
      previousPosition = latLng;

      // Check for stops
      if (data.speed === 0) {
        if (!currentStop) {
          currentStop = { startTime: new Date().getTime(), location: latLng };
        }
      } else {
        if (currentStop) {
          currentStop.endTime = new Date().getTime();
          stops.push(currentStop);
          currentStop = null;
          document.getElementById("stops").textContent = stops.length;
        }
      }
    }
  });

  // Start timer
  interval = setInterval(updateTimer, 1000);
}

function stopTrip() {
  tripActive = false;
  startStopBtn.textContent = "Start Trip";
  clearInterval(interval);

  // Save trip data
  const endTime = new Date().getTime();
  const distance = parseFloat(document.getElementById("distance").textContent);
  database.ref(`trips/${tripId}`).update({
    startTime: startTime,
    endTime: endTime,
    status: "completed",
    maxSpeed: maxSpeed,
    distance: distance,
    stops: stops,
    path: path.map((point) => ({ latitude: point.lat(), longitude: point.lng() })),
  });

  // Display trip summary
  document.getElementById("timeTaken").textContent = formatTime(endTime - startTime);
}

function updateTimer() {
  const currentTime = new Date().getTime();
  document.getElementById("timeTaken").textContent = formatTime(currentTime - startTime);
}

function formatTime(milliseconds) {
  const totalSeconds = Math.floor(milliseconds / 1000);
  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = totalSeconds % 60;
  return `${String(hours).padStart(2, "0")}:${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
}

// Initialize map
initMap();
  </script>
</body>
